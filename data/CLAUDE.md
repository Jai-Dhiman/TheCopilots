# Data Agent — CLAUDE.md

> You inherit root `CLAUDE.md`. Don't duplicate — this extends it with data-specific context.

## Scope

This module owns all knowledge data: ASME Y14.5-2018 rules structured as JSON, tolerance capability tables, material property tables, datum scheme patterns, pre-computed embeddings, and synthetic training data. You are the "Brain" layer of the InstaLILY architecture.

## Tech Decisions (Already Made)

- **Format:** JSON files for structured knowledge, JSONL for training data, NPZ for embeddings
- **Standards source:** ASME Y14.5-2018 (US standard). NO ISO 1101 mixing.
- **Embeddings model:** all-MiniLM-L6-v2 (384-dimensional vectors)
- **Training data generation:** Gemini 2.5 Pro API (pre-hackathon only)
- **Storage:** Files in this directory, loaded into SQLite by `scripts/seed_database.py`

## File Responsibilities

### `standards/asme_y14_5.json` — GD&T rules database ⚠️ SHARED

- All 14 geometric characteristic symbols with rules, applicability, modifiers
- Feature control frame syntax rules
- Datum selection rules and principles
- Material condition modifier rules (MMC, LMC, RFS)
- **Referenced by backend brain AND scripts — coordinate before editing**

Structure per characteristic:

```
{
  "symbol": "⊕",
  "unicode": "⊕",
  "name": "Position",
  "category": "location",
  "asme_section": "§7.2",
  "datum_required": true,
  "applicable_modifiers": ["MMC", "LMC", "RFS"],
  "applicable_features": ["hole", "boss", "slot", "pattern", "tab"],
  "tolerance_zone": "cylindrical (∅) or linear",
  "rules": [
    "Position tolerance defines a zone within which the axis or center plane of a feature may vary from true position",
    "True position is established by basic dimensions from datums",
    "MMC modifier allows bonus tolerance equal to departure from MMC size"
  ],
  "when_to_use": "Features that must align with mating features — bolt holes, pin locations, slot positions. Most common GD&T control.",
  "when_NOT_to_use": "Curved or complex surfaces — use profile instead. Single features without mating requirements — form controls may suffice.",
  "common_mistakes": [
    "Forgetting to include datum references (position REQUIRES datums)",
    "Using position on curved surfaces where profile is more appropriate",
    "Not applying MMC when the feature is a clearance-fit hole"
  ],
  "example_callout": "|⊕| ∅0.25 Ⓜ | A | B | C |"
}
```

### `standards/tolerance_tables.json` — Process capability data

Manufacturing tolerance capabilities by process, material class, and feature type:

```
{
  "cnc_milling": {
    "description": "3-axis or 5-axis CNC milling",
    "materials": {
      "aluminum": {
        "typical_position": {"min_mm": 0.025, "max_mm": 0.127},
        "typical_flatness": {"min_mm": 0.013, "max_mm": 0.050},
        "typical_perpendicularity": {"min_mm": 0.013, "max_mm": 0.050},
        "surface_finish_ra": {"min_um": 0.8, "max_um": 3.2}
      },
      "steel": { ... },
      "stainless_steel": { ... }
    }
  },
  "cnc_turning": { ... },
  "injection_molding": { ... },
  "sheet_metal": { ... },
  "die_casting": { ... },
  "3d_printing_fdm": { ... },
  "3d_printing_sla": { ... },
  "grinding": { ... }
}
```

### `standards/material_properties.json` — Material database

Common engineering materials with properties relevant to tolerancing:

```
{
  "AL6061-T6": {
    "name": "Aluminum 6061-T6",
    "category": "aluminum",
    "common_processes": ["cnc_milling", "cnc_turning", "extrusion"],
    "machinability": "excellent",
    "thermal_expansion_ppm_c": 23.6,
    "notes": "Most common general-purpose aluminum. Excellent machinability. Widely available."
  }
}
```

### `standards/datum_patterns.json` — Common datum scheme patterns

Patterns that encode senior engineer tribal knowledge:

```
{
  "flat_plate_with_holes": {
    "description": "Flat plate or bracket with mounting holes",
    "primary": {"type": "largest_flat_surface", "reasoning": "Maximum stability, 3-point contact"},
    "secondary": {"type": "locating_hole_or_edge", "reasoning": "Constrains 2 DOF, perpendicular to primary"},
    "tertiary": {"type": "second_hole_or_edge", "reasoning": "Constrains rotation, only if pattern orientation matters"},
    "example_parts": ["mounting bracket", "base plate", "cover plate", "flange"],
    "common_mistakes": ["Using a small feature as primary datum", "Choosing datums that don't correspond to manufacturing fixture"]
  },
  "shaft_with_journals": { ... },
  "housing_with_bore": { ... },
  "cylindrical_part": { ... }
}
```

### `embeddings/standards_embeddings.npz` — Pre-computed vectors

- One 384-dim embedding per ASME Y14.5 section/rule
- Generated by `scripts/embed_standards.py` using all-MiniLM-L6-v2
- Keys: section identifiers matching `asme_y14_5.json`
- Regenerate if standards data changes

### `synthetic/training_pairs.jsonl` — Fine-tuning data

JSONL format, one example per line. Generated by Gemini 2.5 Pro via `scripts/generate_synthetic_data.py`.

Each line contains:

```
{
  "input": {
    "feature_type": "boss",
    "geometry": {"diameter": 12.0, "height": 8.0, "unit": "mm"},
    "material": "AL6061-T6",
    "manufacturing_process": "cnc_milling",
    "mating_condition": "bearing_bore_concentric",
    "parent_surface": "planar_mounting_face"
  },
  "classification": {
    "primary_control": "perpendicularity",
    "symbol": "⊥",
    "tolerance_class": "tight",
    "datum_required": true,
    "modifier": "none",
    "reasoning_key": "bearing_alignment_perpendicularity"
  },
  "full_output": {
    "datum_scheme": {"A": "mounting_face", "B": "boss_od"},
    "callouts": [
      {"feature": "boss", "frame": "|⊥| ∅0.05 | A |", "reasoning": "..."},
      {"feature": "bearing_bore", "frame": "|⊕| ∅0.03 Ⓜ | A | B |", "reasoning": "..."}
    ],
    "warnings": ["Consider flatness on Datum A if face >100mm"]
  }
}
```

Target: 500+ pairs covering all 14 geometric characteristics, common manufacturing processes, and common part archetypes.

### `synthetic/generation_prompts.txt` — Gemini prompts

The exact prompts used with Gemini 2.5 Pro to generate training pairs. Stored for reproducibility.

## Critical Rules

1. **ASME Y14.5-2018 only.** Do not mix in ISO 1101 terminology or conventions.
2. **Tolerance values must be physically achievable.** Every value in tolerance_tables.json must be grounded in real manufacturing capability — not made up.
3. **Training data quality > quantity.** 500 high-quality pairs beat 5000 noisy ones. Each pair must have correct GD&T.
4. **Embeddings are derivative.** If you change `asme_y14_5.json`, you must regenerate embeddings via `scripts/embed_standards.py`.
5. **JSON must be valid and parseable.** The backend loads these files at startup — a single syntax error breaks the whole system.

## ASME Y14.5-2018 Quick Reference

### The 14 Geometric Characteristics

| Category | Symbol | Name | Datum Required? |
|----------|--------|------|-----------------|
| Form | — | Straightness | No |
| Form | ▱ | Flatness | No |
| Form | ○ | Circularity | No |
| Form | ⌭ | Cylindricity | No |
| Orientation | ⊥ | Perpendicularity | Yes |
| Orientation | ∠ | Angularity | Yes |
| Orientation | // | Parallelism | Yes |
| Location | ⊕ | Position | Yes |
| Location | ◎ | Concentricity | Yes |
| Location | ≡ | Symmetry | Yes |
| Profile | ⌒ | Profile of a line | Optional |
| Profile | ⌓ | Profile of a surface | Optional |
| Runout | ↗ | Circular runout | Yes |
| Runout | ↗↗ | Total runout | Yes |

### Material Condition Modifiers

- **MMC (Ⓜ):** Maximum Material Condition — bonus tolerance as feature departs from MMC
- **LMC (Ⓛ):** Least Material Condition — ensures minimum wall thickness
- **RFS:** Regardless of Feature Size — default in Y14.5-2018 (no symbol needed)

### Feature Control Frame Format

```
|symbol| tolerance [modifier] | datum_A | datum_B | datum_C |
```
